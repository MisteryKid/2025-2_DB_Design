<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë¬´ê¸° ê²€ìƒ‰ ì„œë¹„ìŠ¤</title>
    <style>
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
    <link rel="stylesheet" th:href="@{/main.css}">
</head>
<body>

<h1>ğŸ” ë¬´ê¸° ê²€ìƒ‰ ì„œë¹„ìŠ¤</h1>

<form id="searchForm" action="/search" method="get">

    <label for="mainCategory">ì£¼ìš” ì¹´í…Œê³ ë¦¬:</label>
    <select id="mainCategory" name="mainCategoryId">
        <option value="">-- ìƒìœ„ ì„ íƒ --</option>
        <option value="1" th:selected="${selectedMainCategoryId == 1}">ì§€ìƒë¬´ê¸°</option>
        <option value="2" th:selected="${selectedMainCategoryId == 2}">ê³µì¤‘ë¬´ê¸°</option>
        <option value="3" th:selected="${selectedMainCategoryId == 3}">í•´ìƒë¬´ê¸°</option>
    </select>

    <label for="subCategory">ì„¸ë¶€ ì¹´í…Œê³ ë¦¬:</label>
    <select id="subCategory" name="categoryId">
        <option value="">-- ì„¸ë¶€ ì„ íƒ --</option>
    </select>

    <input
            type="text"
            name="keyword"
            placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
            th:value="${searchKeyword}"
    >
    <button type="submit">ê²€ìƒ‰ ì‹œì‘</button>
</form>

<hr>

<h2 th:if="${searchKeyword}">
    '[[${searchKeyword}]]' ê²€ìƒ‰ ê²°ê³¼
</h2>
<h2 th:unless="${searchKeyword}">
    ë¬´ê¸° ëª©ë¡
</h2>

<table th:if="${!#lists.isEmpty(weaponList)}">
    <thead>
    <tr>
        <th>ID</th>
        <th>ì´ë¦„</th>
        <th>ì¹´í…Œê³ ë¦¬</th>
        <th>ì œì¡°ì‚¬</th>
        <th>êµ­ê°€</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="weapon : ${weaponList}"
        th:data-weapon-id="${weapon.id}"
        style="cursor: pointer;"> <td th:text="${weapon.id}">1</td>
        <td th:text="${weapon.name}">K2 í‘í‘œ ì „ì°¨</td>
        <td th:text="${weapon.category.name}">ì „ì°¨</td>
        <td th:text="${weapon.manufacturer.name}">í˜„ëŒ€ë¡œí…œ</td>
        <td th:text="${weapon.country}">ëŒ€í•œë¯¼êµ­</td>
    </tr>
    </tbody>
</table>

<p th:if="${#lists.isEmpty(weaponList)}">
    ì¡°íšŒëœ ë¬´ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. ê²€ìƒ‰ ì¡°ê±´ì„ ë‹¤ì‹œ í™•ì¸í•´ ì£¼ì„¸ìš”.
</p>

</body>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script th:inline="javascript">
    $(document).ready(function() {
        const $mainCategory = $('#mainCategory');
        const $subCategory = $('#subCategory');
        const $searchForm = $('#searchForm');

        // Controllerì—ì„œ ì „ë‹¬ë°›ì€ ì´ì „ ì„ íƒ ê°’ì„ Thymeleafë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const previouslySelectedMainId = '[[${selectedMainCategoryId}]]';
        const previouslySelectedSubId = '[[${selectedCategoryId}]]';

        // 1. í•˜ìœ„ ì¹´í…Œê³ ë¦¬ ë™ì  ë¡œë”© ë° ë³µì› í•¨ìˆ˜
        function loadSubcategories(parentId) {
            $subCategory.empty();
            $subCategory.append('<option value="">-- ì„¸ë¶€ ì„ íƒ --</option>');

            if (parentId) {
                // AJAX í˜¸ì¶œ: ë¶€ëª¨ IDë¥¼ ë°±ì—”ë“œ APIì— ì „ë‹¬
                $.ajax({
                    url: '/api/categories/' + parentId,
                    type: 'GET',
                    success: function(data) {
                        data.forEach(function(category) {
                            $subCategory.append(
                                $('<option>', {
                                    value: category.id,
                                    text: category.name
                                })
                            );
                        });

                        // [ë³µì› ë¡œì§]: AJAX ì™„ë£Œ í›„, ì´ì „ì— ì„ íƒí–ˆë˜ ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ ê°’ì„ ë³µì›
                        if (previouslySelectedSubId && previouslySelectedSubId !== 'null') {
                            $subCategory.val(previouslySelectedSubId);
                        }
                    },
                    error: function(error) {
                        console.error("í•˜ìœ„ ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨", error);
                    }
                });
            }
        }

        // 2. ìƒìœ„ ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        $mainCategory.change(function() {
            const parentId = $(this).val();
            loadSubcategories(parentId);
        });

        // 3. [ì´ˆê¸° ë¡œë”© ì‹œ ë³µì›]: í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒìœ„ ì¹´í…Œê³ ë¦¬ê°€ ì„ íƒë˜ì–´ ìˆì—ˆë‹¤ë©´
        if (previouslySelectedMainId && previouslySelectedMainId !== 'null') {
             // 'change' ì´ë²¤íŠ¸ë¥¼ ê°•ì œë¡œ ë°œìƒì‹œì¼œ í•˜ìœ„ ëª©ë¡ì„ ë¡œë“œí•˜ê³  ì„ íƒ ê°’ì„ ë³µì›í•©ë‹ˆë‹¤.
             $mainCategory.val(previouslySelectedMainId).trigger('change');
        }

        // 4. [ê²€ìƒ‰ í¼ ì „ì†¡ ë¡œì§]: ê²€ìƒ‰ í¼ ì œì¶œ ì‹œ í•„í„°ë§ ê°’ ì¡°ì •
        $searchForm.submit(function(e) {
            const mainId = $mainCategory.val();
            const subId = $subCategory.val();

            // ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ê°€ ë¹„ì–´ìˆê³ , ìƒìœ„ ì¹´í…Œê³ ë¦¬ê°€ ì„ íƒëœ ê²½ìš°:
            // Controllerê°€ ìƒìœ„ IDë¡œ ê²€ìƒ‰í•  ìˆ˜ ìˆë„ë¡ name="categoryId" í•„ë“œì˜ ê°’ì„ ë®ì–´ì”ë‹ˆë‹¤.
            if (!subId && mainId) {
                $subCategory.val(mainId);
            }
        });

        // 5. [ìƒì„¸ í˜ì´ì§€ ì´ë™ ë¡œì§]: í…Œì´ë¸” í–‰ í´ë¦­ ì´ë²¤íŠ¸
        // th:data-weapon-id ì†ì„±ì„ ê°€ì§„ í…Œì´ë¸”ì˜ ëª¨ë“  í–‰ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë¶™ì…ë‹ˆë‹¤.
        $('table tbody tr').click(function() {
            // í´ë¦­ëœ í–‰ì—ì„œ ë¬´ê¸° IDë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const weaponId = $(this).data('weapon-id');

            if (weaponId) {
                // Controllerì— ì •ì˜ëœ ìƒì„¸ í˜ì´ì§€ ê²½ë¡œë¡œ ì´ë™
                window.location.href = '/weapon/' + weaponId;
            }
        });
    });
</script>



</html>